# Piggydb Code Complete Specification

This document provides a comprehensive specification of the core domain logic, data persistence, and import/export mechanisms of the legacy Piggydb application.

## 1. Core Domain Model

The core domain revolves around the concept of a **Fragment**, which can be tagged and related to other fragments.

### 1.1 Fragment
The central entity of the system.
-   **Attributes:**
    -   `id` (Long): Primary Key.
    -   `title` (String): The headline of the fragment.
    -   `content` (String): The body text.
    -   `file_name` (String): Name of the attached file (optional).
    -   `file_type` (String): Extension/type of the file.
    -   `file_size` (Size): Size of the file.
    -   `password` (String): For protected fragments.
    -   `tag_id` (Long): If non-zero, this Fragment acts as the description/body for a Tag.
    -   **Common Attributes:** `creation_datetime`, `creator`, `update_datetime`, `updater`.
-   **Logic:**
    -   **Classifiable:** Can be tagged.
    -   **Hierarchical:** Can have parents and children (via `FragmentRelation`).
    -   **Files:** Can store binary attachments (images, docs).
    -   **Security:** Can be password protected.

### 1.2 Tag
A label used to organize fragments.
-   **Attributes:**
    -   `id` (Long): Primary Key.
    -   `name` (String): The tag name (e.g., "#todo", "knowledge").
    -   `fragment_id` (Long): Link to a Fragment that describes this tag.
    -   **Common Attributes:** `creation_datetime`, `creator`, `update_datetime`, `updater`.
-   **Logic:**
    -   **Tags as Fragments:** A Tag can be "enriched" by linking it to a Fragment (`fragment_id`). This allows tags to have rich text descriptions and attachments.
    -   **Hierarchy:** Tags can tag other Tags (creating a taxonomy).
    -   **System Tags:** Special tags starting with `#` (e.g., `#trash`, `#home`, `#public`).

### 1.3 FragmentRelation
Defines a directed graph edge between two Fragments.
-   **Attributes:**
    -   `from` (Fragment): The parent/source.
    -   `to` (Fragment): The child/target.
    -   `priority` (Integer): For ordering children.
    -   `twoWay` (Boolean): Bidirectional relationship flag.
    -   **Common Attributes:** `creation_datetime`, `creator`, `update_datetime`, `updater`.

### 1.4 Tagging
The association between a Tag and a Target (Fragment, Filter, or another Tag).
-   **Attributes:**
    -   `tag_id`: The ID of the tag.
    -   `target_id`: The ID of the object being tagged.
    -   `target_type`: Discriminator for the target type.
        -   `1`: TAG (Hierarchical tagging)
        -   `2`: FRAGMENT (Standard tagging)
        -   `3`: FILTER_INCLUDES
        -   `4`: FILTER_EXCLUDES

---

## 2. Data Persistence (H2 Schema)

The legacy application uses H2 Database. The schema is defined as follows:

### 2.1 Table: `fragment`
| Column | Type | Description |
| :--- | :--- | :--- |
| `fragment_id` | BIGINT | PK |
| `title` | VARCHAR | |
| `content` | VARCHAR | |
| `file_name` | VARCHAR | |
| `file_type` | VARCHAR | |
| `file_size` | BIGINT | |
| `password` | VARCHAR | |
| `tag_id` | BIGINT | Reference to `tag.tag_id` (if this fragment backs a tag) |
| `creation_datetime` | TIMESTAMP | |
| `creator` | VARCHAR | |
| `update_datetime` | TIMESTAMP | |
| `updater` | VARCHAR | |

### 2.2 Table: `tag`
| Column | Type | Description |
| :--- | :--- | :--- |
| `tag_id` | BIGINT | PK |
| `tag_name` | VARCHAR | |
| `fragment_id` | BIGINT | Reference to `fragment.fragment_id` (description) |
| `creation_datetime` | TIMESTAMP | |
| `creator` | VARCHAR | |
| `update_datetime` | TIMESTAMP | |
| `updater` | VARCHAR | |

### 2.3 Table: `tagging`
| Column | Type | Description |
| :--- | :--- | :--- |
| `tag_id` | BIGINT | FK to `tag` |
| `target_id` | BIGINT | FK to target (fragment or tag) |
| `target_type` | TINYINT | 1=Tag, 2=Fragment, 3/4=Filter |

### 2.4 Table: `fragment_relation`
| Column | Type | Description |
| :--- | :--- | :--- |
| `fragment_relation_id`| BIGINT | PK |
| `from_id` | BIGINT | FK to `fragment` (parent) |
| `to_id` | BIGINT | FK to `fragment` (child) |
| `priority` | INT | Sort order |
| `two_way` | BOOLEAN | |
| `creation_datetime` | TIMESTAMP | |
| `creator` | VARCHAR | |
| `update_datetime` | TIMESTAMP | |
| `updater` | VARCHAR | |

### 2.5 Table: `global_setting`
Stores key-value pairs for system configuration (e.g., database version).

---

## 3. Import / Export Mechanism

The system uses a custom format based on **DbUnit** and **ZIP** compression.

### 3.1 Export Format (`PigDump`)
The export is a ZIP file containing:
1.  **`rdb-dump.xml`**: An XML representation of the database rows (generated by DbUnit).
    -   Root element: `<dataset>`
    -   Child elements match table names (e.g., `<fragment ... />`, `<tag ... />`).
2.  **`files/`**: A directory containing raw file attachments.
    -   Files are referenced by the `fragment` table.

### 3.2 Export Logic (`ExportDatabase.java` / `PigDump.java`)
1.  **DB Dump:** Streams the JDBC ResultSet for specific tables (`global_setting`, `tag`, `tagging`, `fragment`, `filter`, `fragment_relation`) into the XML writer.
2.  **File Dump:** Iterates through the `FileRepository` and copies stored files into the ZIP entry `files/`.

### 3.3 Import Logic
1.  **Unzip:** Extracts the ZIP archive.
2.  **DB Restore:**
    -   Parses `rdb-dump.xml`.
    -   Executes a `CLEAN_INSERT` operation (clears existing data, inserts new data) using DbUnit.
3.  **File Restore:** Copies files from `files/` back to the active `FileRepository`.

---

## 4. Web API Surface

The legacy application is primarily server-side rendered (Apache Click), but has a nascent JSON API.

### 4.1 Page Controllers (Apache Click)
The UI is driven by Page classes (e.g., `HomePage`, `FragmentPage`). These handle form submissions and rendering but are not suitable for direct API consumption.

### 4.2 JSON API (`/api/*`)
Implemented using Spark Java.
-   **Authentication:**
    -   `GET /api/login?user=...&password=...`: Returns a session ID.
    -   `GET /api/logout`: Invalidates session.
-   **Endpoints:**
    -   Currently limited (`/hello`).
    -   **Redesign Requirement:** The new system must expand this to cover full CRUD for Fragments and Tags to support a modern frontend.
